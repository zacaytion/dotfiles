function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 *
 * 
 */

var _utilsFirstNode = require('../utils/FirstNode');

var _utilsFirstNode2 = _interopRequireDefault(_utilsFirstNode);

var _utilsNewLine = require('../utils/NewLine');

var _utilsNewLine2 = _interopRequireDefault(_utilsNewLine);

var _utilsStringUtils = require('../utils/StringUtils');

var _utilsHasOneRequireDeclaration = require('../utils/hasOneRequireDeclaration');

var _utilsHasOneRequireDeclaration2 = _interopRequireDefault(_utilsHasOneRequireDeclaration);

var _utilsIsGlobal = require('../utils/isGlobal');

var _utilsIsGlobal2 = _interopRequireDefault(_utilsIsGlobal);

var _utilsIsRequireExpression = require('../utils/isRequireExpression');

var _utilsIsRequireExpression2 = _interopRequireDefault(_utilsIsRequireExpression);

var _jscodeshift = require('jscodeshift');

var _jscodeshift2 = _interopRequireDefault(_jscodeshift);

var _utilsReprintRequire = require('../utils/reprintRequire');

var _utilsReprintRequire2 = _interopRequireDefault(_utilsReprintRequire);

// Set up a config to easily add require formats
var CONFIG = [
// Handle type imports
{
  searchTerms: [_jscodeshift2['default'].ImportDeclaration, { importKind: 'type' }],
  filters: [_utilsIsGlobal2['default']],
  comparator: function comparator(node1, node2) {
    return (0, _utilsStringUtils.compareStrings)(node1.specifiers[0].local.name, node2.specifiers[0].local.name);
  },
  mapper: function mapper(node) {
    return (0, _utilsReprintRequire2['default'])(node);
  }
},

// Handle side effects, e.g: `require('monkey-patches');`
{
  searchTerms: [_jscodeshift2['default'].ExpressionStatement],
  filters: [_utilsIsGlobal2['default'], function (path) {
    return (0, _utilsIsRequireExpression2['default'])(path.node);
  }],
  comparator: function comparator(node1, node2) {
    return (0, _utilsStringUtils.compareStrings)(node1.expression.arguments[0].value, node2.expression.arguments[0].value);
  },
  mapper: function mapper(node) {
    return (0, _utilsReprintRequire2['default'])(node);
  }
},

// Handle UpperCase requires, e.g: `require('UpperCase');`
{
  searchTerms: [_jscodeshift2['default'].VariableDeclaration],
  filters: [_utilsIsGlobal2['default'], function (path) {
    return isValidRequireDeclaration(path.node);
  }, function (path) {
    return (0, _utilsStringUtils.isCapitalized)(getDeclarationName(path.node));
  }],
  comparator: function comparator(node1, node2) {
    return (0, _utilsStringUtils.compareStrings)(getDeclarationName(node1), getDeclarationName(node2));
  },
  mapper: function mapper(node) {
    return (0, _utilsReprintRequire2['default'])(node);
  }
},

// Handle lowerCase requires, e.g: `require('lowerCase');`
{
  searchTerms: [_jscodeshift2['default'].VariableDeclaration],
  filters: [_utilsIsGlobal2['default'], function (path) {
    return isValidRequireDeclaration(path.node);
  }, function (path) {
    return !(0, _utilsStringUtils.isCapitalized)(getDeclarationName(path.node));
  }],
  comparator: function comparator(node1, node2) {
    return (0, _utilsStringUtils.compareStrings)(getDeclarationName(node1), getDeclarationName(node2));
  },
  mapper: function mapper(node) {
    return (0, _utilsReprintRequire2['default'])(node);
  }
}];

/**
 * This formats requires based on the left hand side of the require, unless it
 * is a simple require expression in which case there is no left hand side.
 *
 * The groups are:
 *
 *   - import types: import type Foo from 'anything';
 *   - require expressions: require('anything');
 *   - capitalized requires: var Foo = require('anything');
 *   - non-capitalized requires: var foo = require('anything');
 *
 * Array and object destructures are also valid left hand sides. Object patterns
 * are sorted and then the first identifier in each of patterns is used for
 * sorting.
 */
function formatRequires(root) {
  var first = _utilsFirstNode2['default'].get(root);
  if (!first) {
    return;
  }
  var _first = first; // For flow.

  // Create groups of requires from each config
  var nodeGroups = CONFIG.map(function (config) {
    var paths = root.find(config.searchTerms[0], config.searchTerms[1]).filter(function (path) {
      return config.filters.every(function (filter) {
        return filter(path);
      });
    });

    // Save the underlying nodes before removing the paths
    var nodes = paths.nodes().slice();
    paths.forEach(function (path) {
      return (0, _jscodeshift2['default'])(path).remove();
    });
    return nodes.map(function (node) {
      return config.mapper(node);
    }).sort(config.comparator);
  });

  // Build all the nodes we want to insert, then add them
  var allGroups = [[_utilsNewLine2['default'].statement]];
  nodeGroups.forEach(function (group) {
    return allGroups.push(group, [_utilsNewLine2['default'].statement]);
  });
  var nodesToInsert = Array.prototype.concat.apply([], allGroups);
  nodesToInsert.reverse().forEach(function (node) {
    return _first.insertBefore(node);
  });
}

/**
 * Tests if a variable declaration is a valid require declaration.
 */
function isValidRequireDeclaration(node) {
  if (!(0, _utilsHasOneRequireDeclaration2['default'])(node)) {
    return false;
  }
  var declaration = node.declarations[0];
  if (_jscodeshift2['default'].Identifier.check(declaration.id)) {
    return true;
  }
  if (_jscodeshift2['default'].ObjectPattern.check(declaration.id)) {
    return declaration.id.properties.every(function (prop) {
      return prop.shorthand && _jscodeshift2['default'].Identifier.check(prop.key);
    });
  }
  if (_jscodeshift2['default'].ArrayPattern.check(declaration.id)) {
    return declaration.id.elements.every(function (element) {
      return _jscodeshift2['default'].Identifier.check(element);
    });
  }
  return false;
}

function getDeclarationName(node) {
  var declaration = node.declarations[0];
  if (_jscodeshift2['default'].Identifier.check(declaration.id)) {
    return declaration.id.name;
  }
  // Order by the first property name in the object pattern.
  if (_jscodeshift2['default'].ObjectPattern.check(declaration.id)) {
    return declaration.id.properties[0].key.name;
  }
  // Order by the first element name in the array pattern.
  if (_jscodeshift2['default'].ArrayPattern.check(declaration.id)) {
    return declaration.id.elements[0].name;
  }
  return '';
}

module.exports = formatRequires;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21tb24vcmVxdWlyZXMvZm9ybWF0UmVxdWlyZXMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OzhCQVlzQixvQkFBb0I7Ozs7NEJBQ3RCLGtCQUFrQjs7OztnQ0FDTSxzQkFBc0I7OzZDQUM3QixtQ0FBbUM7Ozs7NkJBQ25ELG1CQUFtQjs7Ozt3Q0FDUiw4QkFBOEI7Ozs7MkJBQzdDLGFBQWE7Ozs7bUNBQ0gseUJBQXlCOzs7OztBQVVwRCxJQUFNLE1BQTBCLEdBQUc7O0FBRWpDO0FBQ0UsYUFBVyxFQUFFLENBQ1gseUJBQUssaUJBQWlCLEVBQ3RCLEVBQUMsVUFBVSxFQUFFLE1BQU0sRUFBQyxDQUNyQjtBQUNELFNBQU8sRUFBRSw0QkFFUjtBQUNELFlBQVUsRUFBRSxvQkFBQyxLQUFLLEVBQUUsS0FBSztXQUFLLHNDQUM1QixLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQzlCLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FDL0I7R0FBQTtBQUNELFFBQU0sRUFBRSxnQkFBQSxJQUFJO1dBQUksc0NBQWUsSUFBSSxDQUFDO0dBQUE7Q0FDckM7OztBQUdEO0FBQ0UsYUFBVyxFQUFFLENBQUMseUJBQUssbUJBQW1CLENBQUM7QUFDdkMsU0FBTyxFQUFFLDZCQUVQLFVBQUEsSUFBSTtXQUFJLDJDQUFvQixJQUFJLENBQUMsSUFBSSxDQUFDO0dBQUEsQ0FDdkM7QUFDRCxZQUFVLEVBQUUsb0JBQUMsS0FBSyxFQUFFLEtBQUs7V0FBSyxzQ0FDNUIsS0FBSyxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUNuQyxLQUFLLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQ3BDO0dBQUE7QUFDRCxRQUFNLEVBQUUsZ0JBQUEsSUFBSTtXQUFJLHND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ekMsV0FBTyxXQUFXLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQztHQUM1Qjs7QUFFRCxNQUFJLHlCQUFLLGFBQWEsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxFQUFFO0FBQzVDLFdBQU8sV0FBVyxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQztHQUM5Qzs7QUFFRCxNQUFJLHlCQUFLLFlBQVksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxFQUFFO0FBQzNDLFdBQU8sV0FBVyxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0dBQ3hDO0FBQ0QsU0FBTyxFQUFFLENBQUM7Q0FDWDs7QUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHLGNBQWMsQ0FBQyIsImZpbGUiOiJmb3JtYXRSZXF1aXJlcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgbGljZW5zZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGluXG4gKiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBAZmxvd1xuICovXG5cbmltcG9ydCB0eXBlIHtDb2xsZWN0aW9uLCBOb2RlLCBOb2RlUGF0aH0gZnJvbSAnLi4vdHlwZXMvYXN0JztcblxuaW1wb3J0IEZpcnN0Tm9kZSBmcm9tICcuLi91dGlscy9GaXJzdE5vZGUnO1xuaW1wb3J0IE5ld0xpbmUgZnJvbSAnLi4vdXRpbHMvTmV3TGluZSc7XG5pbXBvcnQge2NvbXBhcmVTdHJpbmdzLCBpc0NhcGl0YWxpemVkfSBmcm9tICcuLi91dGlscy9TdHJpbmdVdGlscyc7XG5pbXBvcnQgaGFzT25lUmVxdWlyZURlY2xhcmF0aW9uIGZyb20gJy4uL3V0aWxzL2hhc09uZVJlcXVpcmVEZWNsYXJhdGlvbic7XG5pbXBvcnQgaXNHbG9iYWwgZnJvbSAnLi4vdXRpbHMvaXNHbG9iYWwnO1xuaW1wb3J0IGlzUmVxdWlyZUV4cHJlc3Npb24gZnJvbSAnLi4vdXRpbHMvaXNSZXF1aXJlRXhwcmVzc2lvbic7XG5pbXBvcnQganNjcyBmcm9tICdqc2NvZGVzaGlmdCc7XG5pbXBvcnQgcmVwcmludFJlcXVpcmUgZnJvbSAnLi4vdXRpbHMvcmVwcmludFJlcXVpcmUnO1xuXG50eXBlIENvbmZpZ0VudHJ5ID0ge1xuICBzZWFyY2hUZXJtczogW2FueSwgP09iamVjdF0sXG4gIGZpbHRlcnM6IEFycmF5PChwYXRoOiBOb2RlUGF0aCkgPT4gYm9vbGVhbj4sXG4gIGNvbXBhcmF0b3I6IChub2RlMTogTm9kZSwgbm9kZTI6IE5vZGUpID0+IG51bWJlcixcbiAgbWFwcGVyOiAobm9kZTogTm9kZSkgPT4gTm9kZSxcbn07XG5cbi8vIFNldCB1cCBhIGNvbmZpZyB0byBlYXNpbHkgYWRkIHJlcXVpcmUgZm9ybWF0c1xuY29uc3QgQ09ORklHOiBBcnJheTxDb25maWdFbnRyeT4gPSBbXG4gIC8vIEhhbmRsZSB0eXBlIGltcG9ydHNcbiAge1xuICAgIHNlYXJjaFRlcm1zOiBbXG4gICAgICBqc2NzLkltcG9ydERlY2xhcmF0aW9uLFxuICAgICAge2ltcG9ydEtpbmQ6ICd0eXBlJ30sXG4gICAgXSxcbiAgICBmaWx0ZXJzOiBbXG4gICAgICBpc0dsb2JhbCxcbiAgICBdLFxuICAgIGNvbXBhcmF0b3I6IChub2RlMSwgbm9kZTIpID0+IGNvbXBhcmVTdHJpbmdzKFxuICAgICAgbm9kZTEuc3BlY2lmaWVyc1swXS5sb2NhbC5uYW1lLFxuICAgICAgbm9kZTIuc3BlY2lmaWVyc1swXS5sb2NhbC5uYW1lLFxuICAgICksXG4gICAgbWFwcGVyOiBub2RlID0+IHJlcHJpbnRSZXF1aXJlKG5vZGUpLFxuICB9LFxuXG4gIC8vIEhhbmRsZSBzaWRlIGVmZmVjdHMsIGUuZzogYHJlcXVpcmUoJ21vbmtleS1wYXRjaGVzJyk7YFxuICB7XG4gICAgc2VhcmNoVGVybXM6IFtqc2NzLkV4cHJlc3Npb25TdGF0ZW1lbnRdLFxuICAgIGZpbHRlcnM6IFtcbiAgICAgIGlzR2xvYmFsLFxuICAgICAgcGF0aCA9PiBpc1JlcXVpcmVFeHByZXNzaW9uKHBhdGgubm9kZSksXG4gICAgXSxcbiAgICBjb21wYXJhdG9yOiAobm9kZTEsIG5vZGUyKSA9PiBjb21wYXJlU3RyaW5ncyhcbiAgICAgIG5vZGUxLmV4cHJlc3Npb24uYXJndW1lbnRzWzBdLnZhbHVlLFxuICAgICAgbm9kZTIuZXhwcmVzc2lvbi5hcmd1bWVudHNbMF0udmFsdWUsXG4gICAgKSxcbiAgICBtYXBwZXI6IG5vZGUgPT4gcmVwcmludFJlcXVpcmUobm9kZSksXG4gIH0sXG5cbiAgLy8gSGFuZGxlIFVwcGVyQ2FzZSByZXF1aXJlcywgZS5nOiBgcmVxdWlyZSgnVXBwZXJDYXNlJyk7YFxuICB7XG4gICAgc2VhcmNoVGVybXM6IFtqc2NzLlZhcmlhYmxlRGVjbGFyYXRpb25dLFxuICAgIGZpbHRlcnM6IFtcbiAgICAgIGlzR2xvYmFsLFxuICAgICAgcGF0aCA9PiBpc1ZhbGlkUmVxdWlyZURlY2xhcmF0aW9uKHBhdGgubm9kZSksXG4gICAgICBwYXRoID0+IGlzQ2FwaXRhbGl6ZWQoZ2V0RGVjbGFyYXRpb25OYW1lKHBhdGgubm9kZSkpLFxuICAgIF0sXG4gICAgY29tcGFyYXRvcjogKG5vZGUxLCBub2RlMikgPT4gY29tcGFyZVN0cmluZ3MoXG4gICAgICBnZXREZWNsYXJhdGlvbk5hbWUobm9kZTEpLFxuICAgICAgZ2V0RGVjbGFyYXRpb25OYW1lKG5vZGUyKSxcbiAgICApLFxuICAgIG1hcHBlcjogbm9kZSA9PiByZXByaW50UmVxdWlyZShub2RlKSxcbiAgfSxcblxuICAvLyBIYW5kbGUgbG93ZXJDYXNlIHJlcXVpcmVzLCBlLmc6IGByZXF1aXJlKCdsb3dlckNhc2UnKTtgXG4gIHtcbiAgICBzZWFyY2hUZXJtczogW2pzY3MuVmFyaWFibGVEZWNsYXJhdGlvbl0sXG4gICAgZmlsdGVyczogW1xuICAgICAgaXNHbG9iYWwsXG4gICAgICBwYXRoID0+IGlzVmFsaWRSZXF1aXJlRGVjbGFyYXRpb24ocGF0aC5ub2RlKSxcbiAgICAgIHBhdGggPT4gIWlzQ2FwaXRhbGl6ZWQoZ2V0RGVjbGFyYXRpb25OYW1lKHBhdGgubm9kZSkpLFxuICAgIF0sXG4gICAgY29tcGFyYXRvcjogKG5vZGUxLCBub2RlMikgPT4gY29tcGFyZVN0cmluZ3MoXG4gICAgICBnZXREZWNsYXJhdGlvbk5hbWUobm9kZTEpLFxuICAgICAgZ2V0RGVjbGFyYXRpb25OYW1lKG5vZGUyKSxcbiAgICApLFxuICAgIG1hcHBlcjogbm9kZSA9PiByZXByaW50UmVxdWlyZShub2RlKSxcbiAgfSxcbl07XG5cbi8qKlxuICogVGhpcyBmb3JtYXRzIHJlcXVpcmVzIGJhc2VkIG9uIHRoZSBsZWZ0IGhhbmQgc2lkZSBvZiB0aGUgcmVxdWlyZSwgdW5sZXNzIGl0XG4gKiBpcyBhIHNpbXBsZSByZXF1aXJlIGV4cHJlc3Npb24gaW4gd2hpY2ggY2FzZSB0aGVyZSBpcyBubyBsZWZ0IGhhbmQgc2lkZS5cbiAqXG4gKiBUaGUgZ3JvdXBzIGFyZTpcbiAqXG4gKiAgIC0gaW1wb3J0IHR5cGVzOiBpbXBvcnQgdHlwZSBGb28gZnJvbSAnYW55dGhpbmcnO1xuICogICAtIHJlcXVpcmUgZXhwcmVzc2lvbnM6IHJlcXVpcmUoJ2FueXRoaW5nJyk7XG4gKiAgIC0gY2FwaXRhbGl6ZWQgcmVxdWlyZXM6IHZhciBGb28gPSByZXF1aXJlKCdhbnl0aGluZycpO1xuICogICAtIG5vbi1jYXBpdGFsaXplZCByZXF1aXJlczogdmFyIGZvbyA9IHJlcXVpcmUoJ2FueXRoaW5nJyk7XG4gKlxuICogQXJyYXkgYW5kIG9iamVjdCBkZXN0cnVjdHVyZXMgYXJlIGFsc28gdmFsaWQgbGVmdCBoYW5kIHNpZGVzLiBPYmplY3QgcGF0dGVybnNcbiAqIGFyZSBzb3J0ZWQgYW5kIHRoZW4gdGhlIGZpcnN0IGlkZW50aWZpZXIgaW4gZWFjaCBvZiBwYXR0ZXJucyBpcyB1c2VkIGZvclxuICogc29ydGluZy5cbiAqL1xuZnVuY3Rpb24gZm9ybWF0UmVxdWlyZXMocm9vdDogQ29sbGVjdGlvbik6IHZvaWQge1xuICBjb25zdCBmaXJzdCA9IEZpcnN0Tm9kZS5nZXQocm9vdCk7XG4gIGlmICghZmlyc3QpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgY29uc3QgX2ZpcnN0ID0gZmlyc3Q7IC8vIEZvciBmbG93LlxuXG4gIC8vIENyZWF0ZSBncm91cHMgb2YgcmVxdWlyZXMgZnJvbSBlYWNoIGNvbmZpZ1xuICBjb25zdCBub2RlR3JvdXBzID0gQ09ORklHLm1hcChjb25maWcgPT4ge1xuICAgIGNvbnN0IHBhdGhzID0gcm9vdFxuICAgICAgLmZpbmQoY29uZmlnLnNlYXJjaFRlcm1zWzBdLCBjb25maWcuc2VhcmNoVGVybXNbMV0pXG4gICAgICAuZmlsdGVyKHBhdGggPT4gY29uZmlnLmZpbHRlcnMuZXZlcnkoZmlsdGVyID0+IGZpbHRlcihwYXRoKSkpO1xuXG4gICAgLy8gU2F2ZSB0aGUgdW5kZXJseWluZyBub2RlcyBiZWZvcmUgcmVtb3ZpbmcgdGhlIHBhdGhzXG4gICAgY29uc3Qgbm9kZXMgPSBwYXRocy5ub2RlcygpLnNsaWNlKCk7XG4gICAgcGF0aHMuZm9yRWFjaChwYXRoID0+IGpzY3MocGF0aCkucmVtb3ZlKCkpO1xuICAgIHJldHVybiBub2Rlcy5tYXAobm9kZSA9PiBjb25maWcubWFwcGVyKG5vZGUpKS5zb3J0KGNvbmZpZy5jb21wYXJhdG9yKTtcbiAgfSk7XG5cbiAgLy8gQnVpbGQgYWxsIHRoZSBub2RlcyB3ZSB3YW50IHRvIGluc2VydCwgdGhlbiBhZGQgdGhlbVxuICBjb25zdCBhbGxHcm91cHMgPSBbW05ld0xpbmUuc3RhdGVtZW50XV07XG4gIG5vZGVHcm91cHMuZm9yRWFjaChncm91cCA9PiBhbGxHcm91cHMucHVzaChncm91cCwgW05ld0xpbmUuc3RhdGVtZW50XSkpO1xuICBjb25zdCBub2Rlc1RvSW5zZXJ0ID0gQXJyYXkucHJvdG90eXBlLmNvbmNhdC5hcHBseShbXSwgYWxsR3JvdXBzKTtcbiAgbm9kZXNUb0luc2VydC5yZXZlcnNlKCkuZm9yRWFjaChub2RlID0+IF9maXJzdC5pbnNlcnRCZWZvcmUobm9kZSkpO1xufVxuXG4vKipcbiAqIFRlc3RzIGlmIGEgdmFyaWFibGUgZGVjbGFyYXRpb24gaXMgYSB2YWxpZCByZXF1aXJlIGRlY2xhcmF0aW9uLlxuICovXG5mdW5jdGlvbiBpc1ZhbGlkUmVxdWlyZURlY2xhcmF0aW9uKG5vZGU6IE5vZGUpOiBib29sZWFuIHtcbiAgaWYgKCFoYXNPbmVSZXF1aXJlRGVjbGFyYXRpb24obm9kZSkpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgY29uc3QgZGVjbGFyYXRpb24gPSBub2RlLmRlY2xhcmF0aW9uc1swXTtcbiAgaWYgKGpzY3MuSWRlbnRpZmllci5jaGVjayhkZWNsYXJhdGlvbi5pZCkpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICBpZiAoanNjcy5PYmplY3RQYXR0ZXJuLmNoZWNrKGRlY2xhcmF0aW9uLmlkKSkge1xuICAgIHJldHVybiBkZWNsYXJhdGlvbi5pZC5wcm9wZXJ0aWVzLmV2ZXJ5KFxuICAgICAgcHJvcCA9PiBwcm9wLnNob3J0aGFuZCAmJiBqc2NzLklkZW50aWZpZXIuY2hlY2socHJvcC5rZXkpLFxuICAgICk7XG4gIH1cbiAgaWYgKGpzY3MuQXJyYXlQYXR0ZXJuLmNoZWNrKGRlY2xhcmF0aW9uLmlkKSkge1xuICAgIHJldHVybiBkZWNsYXJhdGlvbi5pZC5lbGVtZW50cy5ldmVyeShcbiAgICAgIGVsZW1lbnQgPT4ganNjcy5JZGVudGlmaWVyLmNoZWNrKGVsZW1lbnQpLFxuICAgICk7XG4gIH1cbiAgcmV0dXJuIGZhbHNlO1xufVxuXG5mdW5jdGlvbiBnZXREZWNsYXJhdGlvbk5hbWUobm9kZTogTm9kZSk6IHN0cmluZyB7XG4gIGNvbnN0IGRlY2xhcmF0aW9uID0gbm9kZS5kZWNsYXJhdGlvbnNbMF07XG4gIGlmIChqc2NzLklkZW50aWZpZXIuY2hlY2soZGVjbGFyYXRpb24uaWQpKSB7XG4gICAgcmV0dXJuIGRlY2xhcmF0aW9uLmlkLm5hbWU7XG4gIH1cbiAgLy8gT3JkZXIgYnkgdGhlIGZpcnN0IHByb3BlcnR5IG5hbWUgaW4gdGhlIG9iamVjdCBwYXR0ZXJuLlxuICBpZiAoanNjcy5PYmplY3RQYXR0ZXJuLmNoZWNrKGRlY2xhcmF0aW9uLmlkKSkge1xuICAgIHJldHVybiBkZWNsYXJhdGlvbi5pZC5wcm9wZXJ0aWVzWzBdLmtleS5uYW1lO1xuICB9XG4gIC8vIE9yZGVyIGJ5IHRoZSBmaXJzdCBlbGVtZW50IG5hbWUgaW4gdGhlIGFycmF5IHBhdHRlcm4uXG4gIGlmIChqc2NzLkFycmF5UGF0dGVybi5jaGVjayhkZWNsYXJhdGlvbi5pZCkpIHtcbiAgICByZXR1cm4gZGVjbGFyYXRpb24uaWQuZWxlbWVudHNbMF0ubmFtZTtcbiAgfVxuICByZXR1cm4gJyc7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZm9ybWF0UmVxdWlyZXM7XG4iXX0=